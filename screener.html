<script>
  function showTab(tabId) {
    document.querySelectorAll('.screener-tab').forEach(tab => {
      tab.style.display = 'none';
    });
    document.getElementById(tabId).style.display = 'block';

    document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('primary'));
    const tabButtonMap = {
      'ai-tab': 'AI Based',
      'prebuilt-tab': 'Pre-Built',
      'custom-tab': 'Custom'
    };
    document.querySelectorAll('.btn').forEach(btn => {
      if (btn.textContent.trim() === tabButtonMap[tabId]) {
        btn.classList.add('primary');
      } else {
        btn.classList.remove('primary');
        btn.classList.add('secondary');
      }
    });
  }

  document.getElementById('run-custom').addEventListener('click', runScreener);
  document.getElementById('run-prebuilt').addEventListener('click', runPrebuilt);

  function runScreener() {
    const selectedSymbols = Array.from(document.getElementById("symbol-filter").selectedOptions).map(option => option.value);
    const oiMin = parseFloat(document.getElementById("oi-min").value);
    const ivMax = parseFloat(document.getElementById("iv-range").value);
    const pcrMax = parseFloat(document.getElementById("pcr-range").value);
    const deltaMin = parseFloat(document.getElementById("delta-threshold").value);

    console.log("ðŸŸ¢ Custom Screener Request:", {
      selectedSymbols, oiMin, ivMax, pcrMax, deltaMin
    });

    const data = getDummyData();

    const filtered = data.filter(stock => {
      if (selectedSymbols.length > 0 && !selectedSymbols.includes(stock.symbol)) return false;
      if (!isNaN(oiMin) && stock.oiChange < oiMin) return false;
      if (!isNaN(ivMax) && stock.iv > ivMax) return false;
      if (!isNaN(pcrMax) && stock.pcr > pcrMax) return false;
      if (!isNaN(deltaMin) && Math.abs(stock.delta) < deltaMin) return false;

      return true;
    });

    renderResults(filtered);
  }

  function runPrebuilt() {
    const openFilter = document.getElementById('open-filter').value;
    const data = getDummyData();

    const filtered = data.filter(stock => {
      if (openFilter === 'open-high' && Math.abs(stock.open - stock.high) >= 0.01) return false;
      if (openFilter === 'open-low' && Math.abs(stock.open - stock.low) >= 0.01) return false;
      return true;
    });

    renderResults(filtered);
  }

  function renderResults(results) {
    const tbody = document.getElementById('results-body');
    tbody.innerHTML = '';

    if (results.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10">No matching results.</td></tr>';
      return;
    }

    results.forEach(stock => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${stock.symbol}</td>
        <td>${stock.strike}</td>
        <td>${stock.type}</td>
        <td>${stock.delta}</td>
        <td>${stock.oiChange}%</td>
        <td>${stock.iv}%</td>
        <td>${stock.pcr}</td>
        <td>${stock.open}</td>
        <td>${stock.high}</td>
        <td>${stock.low}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function getDummyData() {
    return [
      { symbol: 'NIFTY', strike: 22500, type: 'Call', delta: 0.35, oiChange: 12, iv: 22, pcr: 1.0, open: 22500, high: 22500, low: 22000 },
      { symbol: 'BANKNIFTY', strike: 48500, type: 'Put', delta: -0.42, oiChange: 8, iv: 27, pcr: 1.1, open: 48500, high: 48700, low: 48500 },
      { symbol: 'RELIANCE', strike: 2600, type: 'Call', delta: 0.5, oiChange: 10, iv: 30, pcr: 1.2, open: 2600, high: 2650, low: 2600 },
      { symbol: 'INFY', strike: 1500, type: 'Put', delta: -0.3, oiChange: 6, iv: 25, pcr: 0.9, open: 1500, high: 1500, low: 1490 },
    ];
  }

  window.addEventListener('DOMContentLoaded', () => {
    showTab('custom-tab');
  });
</script>
